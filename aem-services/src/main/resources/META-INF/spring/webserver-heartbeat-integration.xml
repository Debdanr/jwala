<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:task="http://www.springframework.org/schema/task"
       xmlns:int-http="http://www.springframework.org/schema/integration/http"
       xsi:schemaLocation="http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-3.0.xsd
                           http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd
                           http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/integration/http http://www.springframework.org/schema/integration/http/spring-integration-http.xsd">

    <bean id="webServerProvider" class="com.siemens.cto.aem.service.webserver.impl.WebServerServiceFacade">
        <constructor-arg ref="webServerService"/>
    </bean>

    <bean id="webServerStateServiceFacade" class="com.siemens.cto.aem.service.webserver.impl.WebServerStateServiceFacade">
        <constructor-arg ref="webServerStateService"/>
    </bean>

    <bean id="webServerSshCommandExpression" class="org.springframework.integration.config.ExpressionFactoryBean">
        <constructor-arg value="'sc query ' + payload.name"/>
    </bean>

    <bean id="webServerSshHostExpression" class="org.springframework.integration.config.ExpressionFactoryBean">
        <constructor-arg value="payload.host"/>
    </bean>

    <int:channel id="webServerStateRequest"/>
    <int:channel id="failedWebServerStateRequest"/>
    <int:channel id="successfulWebServerStateRequest"/>
    <int:channel id="unsplitWebServerStateRequests"/>
    <int:channel id="splitWebServerStateRequests">
        <int:dispatcher task-executor="webServerStateExecutor"/>
    </int:channel>
    <int:channel id="completedWithoutMessageWebServerStateRequest"/>
    <int:channel id="completedWithMessageWebServerStateRequest"/>
    <int:channel id="webServerServiceExistenceRequest"/>
    <int:channel id="webServerNoService"/>
    <int:channel id="webServerBadHost"/>
    <int:channel id="webServerServiceExistenceResult"/>
    <int:channel id="webServerStateRequestPreparation"/>
    <int:channel id="webServerStateRequests"/>

    <task:executor id="webServerStateExecutor"
                   pool-size="5"
                   queue-capacity="200"
                   keep-alive="5"
                   rejection-policy="CALLER_RUNS"/>

    <int:inbound-channel-adapter id="webServerStateInitiator"
                                 ref="webServerProvider"
                                 method="getAllWebServers"
                                 channel="unsplitWebServerStateRequests" phase="1000">
        <int:poller fixed-delay="30" time-unit="SECONDS"/>
    </int:inbound-channel-adapter>

    <int:chain id="webServerRequestSplitter" input-channel="unsplitWebServerStateRequests" output-channel="splitWebServerStateRequests">
        <int:splitter/>
        <int:header-enricher id="webServerIdHeaderEnricher">
            <int:header name="webServerId" expression="payload.id"/>
        </int:header-enricher>
        <int:header-enricher id="webServerHeaderEnricher">
            <int:header name="webServer" expression="payload"/>
        </int:header-enricher>
    </int:chain>

    <int:chain id="checkWebServerExistenceChain" input-channel="splitWebServerStateRequests" output-channel="webServerServiceExistenceResult">
        <int:header-enricher>
            <int:error-channel value="webServerBadHost"/>
        </int:header-enricher>
        <int:service-activator method="handleSshMessage">
            <bean id="webServerSshHandler" class="com.siemens.cto.aem.si.ssh.SshExecutingService" autowire="constructor">
                <constructor-arg ref="webServerSshCommandExpression"/>
                <constructor-arg ref="webServerSshHostExpression"/>
            </bean>
        </int:service-activator>
    </int:chain>

    <int:router id="webServerServiceExistenceResultRouter" input-channel="webServerServiceExistenceResult" expression="payload.getReturnCode().wasSuccessful()">
        <int:mapping value="true" channel="webServerStateRequestPreparation"/>
        <int:mapping value="false" channel="webServerNoService"/>
    </int:router>

    <int:chain id="webServerPreHttpOutboundChain" input-channel="webServerStateRequestPreparation" output-channel="webServerStateRequest">
        <int:header-enricher default-overwrite="true">
            <int:error-channel ref="failedWebServerStateRequest"/>
        </int:header-enricher>
        <int:transformer id="webServerStatusUriTransformer" expression="headers['webServer'].getStatusUri().toString()"/>
    </int:chain>

    <int-http:outbound-gateway id="webServerHttpOutboundGateway"
                               request-channel="webServerStateRequest"
                               reply-channel="successfulWebServerStateRequest"
                               request-factory="httpRequestFactory"
                               http-method="GET"
                               url-expression="payload"/>

    <int:chain id="failedWebServerHttpChain" input-channel="failedWebServerStateRequest" output-channel="completedWithoutMessageWebServerStateRequest">
        <int:header-enricher id="failedWebServerHttpHeaderEnricher">
            <int:header name="reachableState" value="#{T(com.siemens.cto.aem.domain.model.webserver.WebServerReachableState).UNREACHABLE}"/>
        </int:header-enricher>
        <int:transformer id="failedWebServerHttpTransformer" expression="payload.getFailedMessage().headers['webServerId']"/>
    </int:chain>

    <int:chain id="successfulWebServerHttpChain" input-channel="successfulWebServerStateRequest" output-channel="completedWithoutMessageWebServerStateRequest">
        <int:header-enricher id="successfulWebServerHttpHeaderEnricher">
            <int:header name="reachableState" value="#{T(com.siemens.cto.aem.domain.model.webserver.WebServerReachableState).REACHABLE}"/>
        </int:header-enricher>
        <int:transformer id="successfulWebServerHttpTransformer" expression="headers['webServerId']"/>
    </int:chain>

    <int:chain id="webServerBadHostChain" input-channel="webServerBadHost" output-channel="completedWithMessageWebServerStateRequest">
        <int:header-enricher id="webServerBadHostHeaderEnricher">
            <int:header name="webServerId" expression="payload.getFailedMessage().headers['webServerId']"/>
            <int:header name="reachableState" value="#{T(com.siemens.cto.aem.domain.model.webserver.WebServerReachableState).FAILED}"/>
            <int:header name="failureMessage" expression="@exceptionUtilHelper.getPenultimateRootCause(payload).getMessage()"/>
        </int:header-enricher>
        <int:transformer id="webServerNoServiceTransformer" expression="headers['webServerId']"/>
    </int:chain>

    <int:chain id="webServerNoServiceChain" input-channel="webServerNoService" output-channel="completedWithMessageWebServerStateRequest">
        <int:header-enricher id="webServerNoServiceHeaderEnricher">
            <int:header name="reachableState" value="#{T(com.siemens.cto.aem.domain.model.webserver.WebServerReachableState).FAILED}"/>
            <int:header name="failureMessage" expression="payload.standardErrorOrStandardOut()"/>
        </int:header-enricher>
        <int:transformer id="webServerNoServiceTransformer" expression="headers['webServerId']"/>
    </int:chain>

    <int:chain id="completedSuccessWebServerStateRequestChain" input-channel="completedWithoutMessageWebServerStateRequest">
        <int:outbound-channel-adapter id="completedWebServerStateRequestOutboundAdapter" expression="@webServerStateServiceFacade.setState(payload, headers['reachableState'], {T(org.joda.time.DateTime).now()})"/>
    </int:chain>

    <int:chain id="completedFailureWebServerStateRequestChain" input-channel="completedWithMessageWebServerStateRequest">
        <int:outbound-channel-adapter id="completedWebServerStateRequestOutboundAdapter" expression="@webServerStateServiceFacade.setStateWithMessage(payload, headers['reachableState'], {T(org.joda.time.DateTime).now()}, headers['failureMessage'])"/>
    </int:chain>

    <int:gateway id="explicitWebServerStateGateway" service-interface="com.siemens.cto.aem.service.webserver.WebServerStateGateway">
        <int:method name="setExplicitState" request-channel="completedWithoutMessageWebServerStateRequest"/>
        <int:method name="initiateWebServerStateRequest" request-channel="unsplitWebServerStateRequests"/>
    </int:gateway>

</beans>