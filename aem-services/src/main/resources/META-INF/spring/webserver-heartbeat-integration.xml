<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:task="http://www.springframework.org/schema/task"
       xmlns:int-http="http://www.springframework.org/schema/integration/http"
       xsi:schemaLocation="http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-3.0.xsd
                           http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd
                           http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/integration/http http://www.springframework.org/schema/integration/http/spring-integration-http.xsd">

    <bean id="webServerProvider" class="com.siemens.cto.aem.service.webserver.impl.WebServerServiceFacade">
        <constructor-arg ref="webServerService"/>
    </bean>

    <bean id="webServerStateServiceFacade" class="com.siemens.cto.aem.service.webserver.state.WebServerStateServiceFacade" depends-on="messageListenerContainerPhase">
        <constructor-arg ref="webServerStateService"/>
    </bean>

    <int:channel id="webServerStateRequest"/>
    <int:channel id="failedWebServerStateRequest"/>
    <int:channel id="successfulWebServerStateRequest"/>
    <int:channel id="unsplitWebServerStateRequests"/>
    <int:channel id="completedWebServerStateRequest"/>
    <int:channel id="webServerStateRequests">
        <int:dispatcher task-executor="webServerStateExecutor"/>
    </int:channel>
    <task:executor id="webServerStateExecutor"
                   pool-size="5"
                   queue-capacity="200"
                   keep-alive="5"
                   rejection-policy="CALLER_RUNS"/>

    <int:inbound-channel-adapter id="webServerStateInitiator"
                                 ref="webServerProvider"
                                 method="getAllWebServers"
                                 channel="unsplitWebServerStateRequests" phase="1000">
        <int:poller fixed-delay="30" time-unit="SECONDS"/>
    </int:inbound-channel-adapter>

    <int:chain id="webServerRequestSplitter" input-channel="unsplitWebServerStateRequests" output-channel="webServerStateRequests">
        <int:splitter/>
        <int:header-enricher id="webServerIdHeaderEnricher">
            <int:header name="webServerId" expression="payload.id"/>
        </int:header-enricher>
        <int:transformer id="webServerStatusUriTransformer" expression="payload.getStatusUri().toString()"/>
    </int:chain>

    <int:chain id="webServerPreHttpOutboundChain" input-channel="webServerStateRequests" output-channel="webServerStateRequest">
        <int:header-enricher>
            <int:error-channel value="failedWebServerStateRequest"/>
        </int:header-enricher>
    </int:chain>

    <int-http:outbound-gateway id="webServerHttpOutboundGateway"
                               request-channel="webServerStateRequest"
                               reply-channel="successfulWebServerStateRequest"
                               request-factory="httpRequestFactory"
                               http-method="GET"
                               url-expression="payload"/>

    <int:chain id="failedWebServerHttpChain" input-channel="failedWebServerStateRequest" output-channel="completedWebServerStateRequest">
        <int:header-enricher id="failedWebServerHttpHeaderEnricher">
            <int:header name="reachableState" value="#{T(com.siemens.cto.aem.domain.model.webserver.WebServerReachableState).UNREACHABLE}"/>
        </int:header-enricher>
        <int:transformer id="failedWebServerHttpTransformer" expression="payload.getFailedMessage().headers['webServerId']"/>
    </int:chain>

    <int:chain id="successfulWebServerHttpChain" input-channel="successfulWebServerStateRequest" output-channel="completedWebServerStateRequest">
        <int:header-enricher id="successfulWebServerHttpHeaderEnricher">
            <int:header name="reachableState" value="#{T(com.siemens.cto.aem.domain.model.webserver.WebServerReachableState).REACHABLE}"/>
        </int:header-enricher>
        <int:transformer id="successfulWebServerHttpTransformer" expression="headers['webServerId']"/>
    </int:chain>

    <int:chain id="completedWebServerStateRequestChain" input-channel="completedWebServerStateRequest">
        <int:outbound-channel-adapter id="completedWebServerStateRequestOutboundAdapter" expression="@webServerStateServiceFacade.setState(payload, headers['reachableState'], {T(org.joda.time.DateTime).now()})"/>
    </int:chain>
</beans>