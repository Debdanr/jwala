<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:task="http://www.springframework.org/schema/task"
	xsi:schemaLocation="http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-3.0.xsd http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">
     
    <bean id="messageTiming" class="com.siemens.cto.aem.service.group.impl.MessageTimingChannelInterceptor" />

    <int:channel id="jvmStateUpdates" />
    <int:channel id="webServerStateUpdates" />
    <int:channel id="groupStateUpdates" />
    <int:channel id="groupStateLogging" />
        
    <!--  use direct channel for now 
    <int:publish-subscribe-channel id="groupStateLogging" task-executor="statePubSubBusExecutor"/>  -->      

    <!-- All channels are timed -->
    <int:channel-interceptor ref="messageTiming" pattern="group*, jvm*, web*, state*" order="0"/>    

    <int:gateway id="stateNotification" service-interface="com.siemens.cto.aem.service.state.StateNotificationGateway">
        <int:method name="jvmStateChanged" request-channel="jvmStateUpdates"/>
        <int:method name="webServerStateChanged" request-channel="webServerStateUpdates"/>
        <int:method name="groupStateChanged" request-channel="groupStateUpdates"/>
    </int:gateway>

    <!-- Only used For Logging Results 
    <task:executor id="statePubSubBusExecutor" pool-size="3-5"
        queue-capacity="100" keep-alive="3" rejection-policy="DISCARD" />-->
    
    <int:splitter auto-startup="true" 
           input-channel="jvmStateUpdates"
           output-channel="groupStateUpdates"
           method="stateUpdateJvm"
           ref="groupStateService" />

    <int:splitter auto-startup="true"
           input-channel="webServerStateUpdates"
           output-channel="groupStateUpdates"
           method="stateUpdateWebServer"
           ref="groupStateService" />

    <!-- Handle group persistence and notification -->
    <int:chain input-channel="groupStateUpdates" output-channel="groupStateLogging">
         <int:service-activator 
                method="groupStatePersist"
                ref="groupStateService" />
         <!-- Unlock group state object to serialize group states with persisting data -->
         <int:service-activator 
                method="groupStateUnlock"
                ref="groupStateService" />
         <!-- Notification to listeners from the UI -->
         <int:service-activator 
                method="groupStateNotify"
                ref="groupStateService" />
    </int:chain> 
    
    <!-- Finishes the chain with a subscriber who logs. -->
    <int:logging-channel-adapter 
        id="stateUpdateLogging"
        channel="groupStateLogging"
        level="TRACE" 
        logger-name="com.siemens.cto.aem.bus"
        expression="'TIMING: Message complete after ' + ( #root.headers.get('startMs') == null ? '?':(T(java.lang.System).currentTimeMillis() - #root.headers.get('startMs'))) +  'ms: ' + #root">
    </int:logging-channel-adapter>
   
</beans>