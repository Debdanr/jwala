<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:task="http://www.springframework.org/schema/task"
	xsi:schemaLocation="http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-3.0.xsd http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

	<task:executor id="commonCommandExecutor" pool-size="10"
		queue-capacity="20" keep-alive="5" rejection-policy="CALLER_RUNS" />

	<int:gateway id="commandDispatch" default-request-channel="command-accept"
		service-interface="com.siemens.cto.aem.service.dispatch.CommandDispatchGateway"></int:gateway>

	<int:channel id="command-accept">
		<int:queue capacity="3000" />
	</int:channel>

	<int:payload-type-router input-channel="command-accept">
		<int:poller max-messages-per-poll="1" fixed-delay="10"
			receive-timeout="30000" task-executor="commonCommandExecutor" />
		<int:mapping
			type="com.siemens.cto.aem.domain.model.dispatch.GroupJvmDispatchCommand"
			channel="splitJvms" />
	</int:payload-type-router>

	<int:channel id="splitJvms" />

	<int:channel id="subcommand-error" />

	<int:chain input-channel="splitJvms" output-channel="jvmAggregated">
		<int:splitter ref="commandDecomposerBean" method="splitGroupToJvmCommands" />
		<int:service-activator method="startStop"
			ref="jvmCommandExecutorBean" />
		<int:aggregator id="dispatchCommandAggregator"
			message-store="commandExecutionMessageStore"
			send-partial-result-on-expiry="true" discard-channel="subcommand-error" />
	</int:chain>

	<int:channel id="jvmAggregated" />

	<int:service-activator id="groupControlServiceActivator"
		input-channel="jvmAggregated" method="dispatchCommandComplete" ref="groupControlService" />

	<bean id="commandExecutionMessageStore"
		class="org.springframework.integration.store.SimpleMessageStore" />

	<!-- Expire results for jobs that are complete, or stuck -->
	<bean id="commandExecutionMessageStoreReaper"
		class="com.siemens.cto.aem.service.dispatch.impl.CommandExecutionMessageStoreReaper">
		<property name="messageGroupStore" ref="commandExecutionMessageStore" />
		<property name="timeout" value="360000" />
		<!-- All commands in a group must end within 5 minutes or they will be 
			reaped. ?? -->
	</bean>

	<!-- Do the expiration once every second -->
	<task:scheduled-tasks>
		<task:scheduled ref="commandExecutionMessageStoreReaper"
			method="run" fixed-rate="1000" />
	</task:scheduled-tasks>

	<bean id="commandDecomposerBean"
		class="com.siemens.cto.aem.service.dispatch.impl.CommandDecomposerBeanImpl" />
	<bean id="jvmCommandExecutorBean"
		class="com.siemens.cto.aem.service.dispatch.impl.JvmCommandExecutorBeanImpl">
		<constructor-arg ref="jvmControlService" />
	</bean>
</beans>