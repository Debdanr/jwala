<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd">

    <int:channel id="incomingSshRequests"/>
    <int:channel id="successfulSshRequests"/>
    <int:channel id="failedSshRequests"/>

    <bean id="testServiceAdapter" class="com.siemens.cto.aem.si.TestSshServiceAdapter"/>

    <int:gateway id="jvmExplicitStateGateway" service-interface="com.siemens.cto.aem.si.TestSshGateway" error-channel="failedSshRequests">
        <int:method name="initiateRequest" request-channel="incomingSshRequests"/>
    </int:gateway>

    <int:chain input-channel="incomingSshRequests" output-channel="successfulSshRequests">
        <int:service-activator method="handleSshMessage">
            <bean id="sshHandler" class="com.siemens.cto.aem.si.ssh.SshExecutingService" autowire="constructor">
                <constructor-arg>
                    <bean class="org.springframework.integration.config.ExpressionFactoryBean">
                        <constructor-arg value="payload.jvmName"/>
                    </bean>
                </constructor-arg>
                <constructor-arg>
                    <bean class="org.springframework.integration.config.ExpressionFactoryBean">
                        <constructor-arg value="payload.hostName"/>
                    </bean>
                </constructor-arg>
            </bean>
        </int:service-activator>
    </int:chain>

    <int:service-activator input-channel="successfulSshRequests" ref="testServiceAdapter" method="completeRequest"/>

    <int:service-activator input-channel="failedSshRequests" expression="@testServiceAdapter.completeErrorRequest(payload.getFailedMessage().getPayload())"/>

</beans>